@using Microsoft.AspNetCore.Http
@model List<N16_MilkTea.Models.CartItem>
@{
    ViewData["Title"] = "Gi·ªè h√†ng";
}

<div class="container py-5">
    <h2 class="fw-bold mb-4">üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    @if (Model.Count > 0)
    {
        <div class="row">
            <div class="col-lg-8">
                <div class="card shadow-sm border-0 mb-3">
                    <div class="card-body p-0">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>M√≥n</th>
                                    <th>Gi√°</th>
                                    <th>SL</th>
                                    <th>T·ªïng</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="~/images/@item.ImageUrl" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" class="me-2" onerror="this.src='https://placehold.co/50'">
                                                <div>
                                                    <span class="fw-bold d-block">@item.ProductName</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@item.Price.ToString("#,##0")</td>
                                        <td>@item.Quantity</td>
                                        <td class="fw-bold">@item.Total.ToString("#,##0")</td>
                                        <td>
                                            <a asp-action="Remove" asp-route-id="@item.ProductId" class="text-danger"><i class="bi bi-trash"></i></a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h5 class="fw-bold mb-3">M√£ gi·∫£m gi√°</h5>
                        
                        <div class="input-group mb-3">
                            <input type="text" id="voucherInput" class="form-control" placeholder="Nh·∫≠p m√£ (VD: HELLON16)" value="@ViewBag.VoucherCode">
                            <button class="btn btn-dark" type="button" onclick="useVoucher()">√Åp d·ª•ng</button>
                        </div>

                        <hr>
                        <div class="d-flex justify-content-between mb-2">
                            <span>T·∫°m t√≠nh:</span>
                            <span>@ViewBag.Total.ToString("#,##0") ƒë</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Gi·∫£m gi√°:</span>
                            <span>-@ViewBag.Discount.ToString("#,##0") ƒë</span>
                        </div>
                        <div class="d-flex justify-content-between mb-4">
                            <span class="fw-bold fs-5">Th√†nh ti·ªÅn:</span>
                            <span class="fw-bold fs-5 text-danger">@ViewBag.FinalTotal.ToString("#,##0") ƒë</span>
                        </div>

                        @if (Context.Session.GetString("MaKh") != null)
                        {
                            <a asp-controller="Payment" asp-action="CheckoutCOD" class="btn btn-outline-primary w-100 mb-2">
                                Thanh to√°n khi nh·∫≠n h√†ng
                            </a>
                            <a asp-controller="Payment" asp-action="CreatePaymentUrl" class="btn btn-primary w-100">
                                Thanh to√°n VNPAY
                            </a>
                        }
                        else
                        {
                            <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="/Cart/Index" class="btn btn-warning w-100">
                                ƒêƒÉng nh·∫≠p ƒë·ªÉ thanh to√°n
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <i class="bi bi-cart-x display-1 text-muted"></i>
            <h3 class="mt-3">Gi·ªè h√†ng tr·ªëng tr∆°n!</h3>
            <a href="/" class="btn btn-primary mt-3">ƒêi mua s·∫Øm ngay</a>
        </div>
    }
</div>

@section Scripts {
    <script>
        function useVoucher() {
            var code = document.getElementById("voucherInput").value;
            if (!code) { alert("Vui l√≤ng nh·∫≠p m√£!"); return; }

            // G·ª≠i y√™u c·∫ßu ng·∫ßm (kh√¥ng chuy·ªÉn trang)
            $.post('/Cart/ApplyVoucher', { code: code }, function (res) {
                if (res.success) {
                    alert("‚úÖ " + res.message);
                    location.reload(); // T·∫£i l·∫°i trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë ti·ªÅn
                } else {
                    alert("‚ùå " + res.message);
                }
            }).fail(function() {
                alert("L·ªói k·∫øt n·ªëi Server!");
            });
        }
    </script>
}